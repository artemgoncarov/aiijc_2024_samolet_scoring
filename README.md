# AI Challenge. Группа Самолет - Девелопмент

## Решение команды [RASCAR] MLшарики 2.0
### Члены команды:
[Артём Гончаров](https://github.com/artemgoncarov) \
[Матвей Беляев](https://github.com/moti4k)

# Описание задачи

Необходимо разработать модель скоринга подрядчиков для расчёта вероятности «дефолта» (наличие договоров АРОР или АСОР со снижением объема работ более чем на 10%) на горизонте 6 месяцев. На основе получившийся модели необходимо реализовать интерфейс (Веб-сайт / Чат-бот / Мобильное приложение) для взаимодействия с моделью.

# Описание работы решения

## Заполнение пропусков

В процессе обработки данных была применена методология заполнения пропусков с использованием класса SimpleImputer из библиотеки scikit-learn. В качестве стратегии для заполнения недостающих значений было выбрано среднее арифметическое. Данный подход позволяет сохранить статистическую целостность данных и минимизировать искажения, которые могут возникнуть при использовании других методов, таких как медиана или мода.

## Генерация признаков

![](https://i.imgur.com/6wGK7kH.png)

### Предобработка ID

Был выполнен one-hot encoding для признаков, содержащих неуникальные идентификаторы:
- specialization_id
- project_id
- building_id
- contractor_id

Это позволяет модели самостоятельно определять, каким классам следует уделять большее внимание, а каким — меньшее.

Итого: 1650 фич

### Предобработка дат

![](https://i.imgur.com/Ham2b63.png)

### Финансовые фичи

![](https://i.imgur.com/K97DsBG.png)

### Временные изменения

![](https://i.imgur.com/jqYzXPr.png)

### Графовые методы

![Мы визуализировали граф, он оказался полным и связным. Синим цветом помечены узлы, суммарное расстояние до всех подрядчиков которых минимальное.](https://i.imgur.com/6u5fGXL.jpeg)

![](https://i.imgur.com/2CyzYuI.png)

## Feature Selection

Посколько признаков довольно много (2100) и среди них есть мусорные (их мы создали, когда делали one-hot encoding ID признаков), следовательно их количество нужно уменьшать. Для этого был реализован класс FeatureSelectionModel. Все признаки проходят 6 фильтров:
- Feature Importance:
    - CatBoost
    - RandomForest
    - XGBoost
    - LightGBM
- Линейная корреляция
- Shap-values по CatBoost

Далее отбираются топ 280 признаков по каждому фильтру и все те признаки, что оказались сразу во всех топах - попадают в финальную модель. Таким образом из 2100 признаков отбираются около 70, что значительно ускоряет обучение и точность модели.

![](https://i.imgur.com/2anivYv.png)

## Model selection

В качестве модели мы используем ансамбль 4 моделей:
1) Модель с базовой предобработкой данных.
2) Модель, обученная на признаках топ-5 ближайших соседей.
3) Модель, обученная на проценте дефолта в радиусе 20.
4) **Time Series + Stemming Model**

Ансамблирование моделей помогает при их инференсе и создании предсказаний занулять ошибки предыдущих моделей, тем самым улучшая точность предсказания.

## Time Series + Stemming

Замысловатое название модели, поскольку прямого отношения к моделям временных рядов оно не имеет, но работает по аналогии. В случае, если в обучающей выборке встречаются более 20 записей для одного подрядчика, создается отдельная модель, которая обучается только на этих записях. Таким образом для каждого подрядчика создается и обучается своя собственная модель. Далее делается предсказание основной моделью и имеет вес 0.67, а предсказание временной моделью имеет вес 0.33. Если записей для подрядчика менее 20, то предсказание делается основной моделью - ансамблем первых 3-ёх моделей.

## Выбор финальной модели

Под капотом первых трёх моделей лежат RandomForestClassifier с весом 0.8 и CatBoostClassifier с весом 0.2. Подобраны эти модели были путем перебора всех самых популярных моделей. Были выбраны именно эти модели, так как имели самые высокие метрики RocAuc и Gini.
А под капотом у Time Series Stemming моделей лежат модели CatBoostClassifier.

![](https://i.imgur.com/OeVwxeK.png)

## Подбор Гиперпараметров

Для лучшего качества модели, мы подобрали гиперпараметры при помощи кросс-валидации.
Благодаря этому получается наиболее объективная оценка, так как модели сильно переобучаются и метрики получаются слишком большие, это помогает подобрать наиболее оптимальные параметры.

## Кросс-валидация

Для проверки модели на переобучение применяется кросс-валидация. 
Средний результат кросс-валидации приблизительно совпадает с результатом на лидерборде. Выбрана схема GroupKFold по переменной contract_id, использующая 6 фолдов, так как она гарантирует, что один и тот же контракт не встретится сразу и в обучающей, и в валидационной выборке.

# Интерпретация

Для того, чтобы узнать, как модель получает предсказания, был реализован алгоритм интерпретации. Он строится на основе shap-values по нашим лучшим моделям. Если вероятность получается > 0.5, то алгоритм выдает top-k самых важных признаков, которые усиливали предсказание. А если < 0.5, то top-k признаков, занижавших предсказание. На выходе получается датафрейм с объяснением предсказания для каждой строки.

![](https://i.imgur.com/2Je6FTM.png)
![](https://github.com/artemgoncarov/aiijc_2024_samolet_scoring/blob/main/web/static/output.png)

# Масштабируемость

### Планы на развитие проекта в будущем:

- Добавить больше статистики на веб-сайт
- Подобрать лучшие параметры для алгоритмов над предсказаниями
- Увеличить обучающую выборку при помощи OverSampling
- Запустить модель в продакшн
- Продолжать сотрудничать с кейсодержателями

# Screencast

[![](https://i.imgur.com/yw9yTy0.png)](https://rutube.ru/play/embed/8ef91a83236b6260dbbd6f54dde96bb3/)

# Run

## Virtual environment

Мы предлагаем вам использовать Python версии 3.11.

### Создание виртуального окружения
```
python -m venv venv
```
### Активация окружения

#### Windows:
```
venv\Scripts\activate
```
#### Linux/MacOS:
```
source venv/bin/activate
```

## Скачайте модели

```
mkdir web/final
wget -P ./web/final https://huggingface.co/artemgoncarov/aiijc_samolet_2024/resolve/main/model_cb.cbm
wget -P ./web/final https://huggingface.co/artemgoncarov/aiijc_samolet_2024/resolve/main/model_cb1.cbm
wget -P ./web/final https://huggingface.co/artemgoncarov/aiijc_samolet_2024/resolve/main/model_cb2.cbm
wget -P ./web/final https://huggingface.co/artemgoncarov/aiijc_samolet_2024/resolve/main/model_rf.joblib
wget -P ./web/final https://huggingface.co/artemgoncarov/aiijc_samolet_2024/resolve/main/model_rf1.joblib
wget -P ./web/final https://huggingface.co/artemgoncarov/aiijc_samolet_2024/resolve/main/model_rf2.joblib
wget -P ./web/final https://huggingface.co/artemgoncarov/aiijc_samolet_2024/resolve/main/simple_model.joblib
wget -P ./web/final https://huggingface.co/artemgoncarov/aiijc_samolet_2024/resolve/main/timeseries.joblib
```

### Установка библиотек

```
pip install -r requirements.txt
```

## Запуск

Перейдите в папку web командой:

```
cd web
```

Далее запустите сервер:

```
python app.py
```

Далее у вас будет доступен веб-интерфейс по локальному адресу http://127.0.0.1:5000

# Описание файлов

## train.ipynb

Ноутбук с обучением модели.

## EDA.ipynb

Ноутбук с развертнутым анализом данных.

## web/app.py

Главный файл - запуск веб-интерфейса.

## web/data_preprocessing.py

Предобработка данных для создания предикта

## web/model.py

Файл с классом модели для инференса

## web/timeseries.py

Файл с классом Time Series Stemming модели для инференса

# Рекомендуем к подписке на ТГ-каналы нашего сообщества

https://t.me/rascar_ai \
https://t.me/ml_with_artem
